{% load custom_filtering_tags %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
{% endblock %}

{% block content %}
<div>
<!-- Button trigger modal -->

<div class="row pt-2 pb-2">
  <div class="col-2">

  </div>
  <div class="col-8">
    <a type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#damageModal-{{user|remove_everything_after_hashtag}}">
      {{user}}
    </a>
  </div>
  <div class="col-2">

  </div>
</div>

  <div class="modal fade" id="damageModal-{{user|remove_everything_after_hashtag}}" tabindex="-1" role="dialog" aria-labelledby="damageModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">

          <h5 class="modal-title font-color-black" id="exampleModalLabel">{{ user }} Last matches data</h5>
        
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <canvas id="damage-chart-{{user|remove_everything_after_hashtag}}" data-url="{% url 'chart_stats_key' team_name=team user=user key='damageDone' %}"></canvas>
            </div>
          </div>
      
          <div class="row">
            <div class="col-12">
              <canvas id="kda-chart-{{user|remove_everything_after_hashtag}}" data-url="{% url 'chart_stats_key' team_name=team user=user key='kd' %}"></canvas>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <canvas id="placement-chart-{{user|remove_everything_after_hashtag}}" data-url="{% url 'chart_stats_key' team_name=team user=user key='teamPlacement' %}"></canvas>
            </div>
          </div>

        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascript %}
<script>

    var chart;
    var activision_tag = "{{ user|remove_everything_after_hashtag }}";

    runCharts(activision_tag);

    function runCharts (user) {
      initializeCharts(user).then(() => {
        createChart(user, chartId = "#damage-chart-" + user, label = "Damage per minute", color = "#1d8187", title = "Damage over last games", xAxisLabel = "Matches", yAxisLabel = "Damage");
        createChart(user, chartId = "#kda-chart-" + user, label = "KDA", color = "#1e242b", title = "KD over last games", xAxisLabel = "Matches", yAxisLabel = "KD");
        createChart(user, chartId = "#placement-chart-" + user, label = "Placement", color = "#7d838d", title = "Placements over last games", xAxisLabel = "Matches", yAxisLabel = "Placements");
        console.log(chart)
      })
    }
  
    async function initializeCharts(user_tag) {
      initChart("damage-chart-" + user_tag);
      initChart("kda-chart-" + user_tag);
      initChart("placement-chart-" + user_tag);
    }

    function initChart(chartId) {
        // Initializes chart with random
        // data - This needs to be done
        // Otherwise the modal will not
        // be able to show anything
        // https://stackoverflow.com/questions/36650455/chart-js-cannot-read-property-length-of-undefined
        // console.log("Initialized chart for");
        // console.log(chartId);

        chart = new Chart(document.getElementById(chartId), {
            type: 'line',
            data: {
                labels: [1,2,3,4,5],
                datasets: [{ 
                        data: [1,2,3,4,5],
                        label: "TEST",
                        borderColor: "#3e95cd",
                        fill: false
                }]
            },
            options: {
              events: [],
            }
        });
    }
  
    function createChart(user, chartId, label, color, title, xAxisLabel, yAxisLabel) {
        var $chart = $(chartId);

        // $("canvas#damage-chart-" + user).remove();
        // $("canvas#kda-chart-" + user).remove();
        // $("canvas#placement-chart-" + user).remove();

        // on

        // $("div.col-12").append('<canvas id="damage-chart-" + user></canvas>');
        // $("div.col-12").append('<canvas id="kda-chart-" + user></canvas>');
        // $("div.col-12").append('<canvas id="placement-chart-" + user></canvas>');

        if (typeof chart)
  
        $.ajax({
                url: $chart.data("url"),
                success: function (data) {
  
                    var ctx = $chart[0].getContext("2d");

                    chart.clear();
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.matches,
                            datasets: [{
                                label: label,
                                borderColor: color,
                                data: data.key,
                                fill: false
                            }]        
                        },
                        options: {
                            events: [],
                            maintainAspectRatio: false,
                            responsive: true,
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: title
                            },
                            scales: {
                                    yAxes: [{
                                        scaleLabel: {
                                            display: true,
                                            labelString: yAxisLabel
                                        }
                                    }],
                                    xAxes: [{
                                        scaleLabel: {
                                            display: true,
                                            labelString: xAxisLabel
                                        }
                                    }]
                                }
                        }
                    });
  
                }
            });
  
        };
  </script>

{% endblock %}